\section{Market Making}
\subsection{Что это такое}

Когда человек приходит на биржу, он хочет купить актив по рыночной цене.
Если биржа $A$ продает биткоины по 11k\$, а биржа $B$ по 10k\$, то выгоднее покупать биткоины у $B$. Чтобы $A$ не терять клиентов, она пользуется услугами маркет-мейкеров.

Маркет-мейкеры решают проблему дисбаланса цен между биржами. Они могут за вознаграждение от биржи $A$ продать у них биткоины  и выровнять курс до 10k\$, и тогда всем остальным будет снова выгодно торговать на бирже $A$. Аналогично работает, когда на бирже $A$ курс ниже относитьно других бирж: маркет-мейкеры закупятся биткоинами. В стабильное время маркет-мейкеры занимаются поддержанием маленького спреда, то есть делают так, что цены покупки и продажи отличаются как можно меньше.


На децентрализованных биржах все еще интереснее.
Так как там биткоин не привязан к бирже, то стратегия выше выгодня для маркет-мейкеров, потому что они могут на бирже $A$ продать биткоины по 11k\$, и купить на $B$ по 10k\$, заработав разнице в ценах, пока они не выровняются. 

Однако межбиржевые операции очень дорогие и долгие, поэтому чаще всего маркет-мейкеры зарабатывают на резких инертных скачках рынка и вознаграждения от биржи.

Для второго нужно очень много денег, так что попробуем заработать на первом.

\subsection{Как это работает}
Заработать можно в предположении краткосрочно высоко-инерционного рынка.

\definition \textbf{Пробитием} будем называть ту заявку, которую мы не успели отменить, и по ней у нас открылась позиция.

\begin{algorithm}
Market-Making orders
\begin{enumerate}

    \item \label{mm:init} Выставляем лимитные заявки в обе стороны на $\pm \Delta_1$ от индекс-цены.
    
    \item \label{mm:swap} Когда индекс-цена изменяется, переставляем заявки на ту же самую $\pm \Delta_1$, но уже от новой цены.
    
    \item Если переставиться успели, и нас не пробили, то переходим к шагу \ref{mm:swap}
    
    \item Неумаляя общности нас пробили на покупку по цене $p$. Отменяем все заявки
    
    \item Выставляем заявку на продажу на $\Delta_2$ от цены, по которой нас пробили на покупку
    
    \item \label{mm:win} Когда заявка исполнилась, возвращаемся к шагу \ref{mm:init}
    
\end{enumerate}
\end{algorithm}

В итоге на шаге \ref{mm:win} мы заработает $\Delta_2 \cdot p$.

\subsection{Реализация}
\href{https://github.com/dexety/dex-trading-system/tree/main/research/lp-0003-market-making}{Стратегия в репозитории}

Программа работает в трех потоках, которые нужны для: 

\begin{enumerate}

\item Выставление ордеров
\begin{enumerate}
    \item В этом потоке мы получаем новый трейды.
    \item Если цена нового трейда не такая, как у прошлого, и цена ордера, который надо выставить не такая, как у нас сейчас стоит, то мы отменяем текущие ордера и выставляем новые.
    \item Перестановка ордеров переходит не через сначала отмену, старых, а потом выставления новых ордеров, а непосредственно через переставление позиций аргументом \texttt{cancel\_id} в функции \texttt{create\_order}. Это позволило сократить количество запросов в два раза, а значит ошибка \texttt{Too many requests} будет встречаться реже.
\end{enumerate}

\item Получение обновлений ордербука
\begin{enumerate}
    \item В предыдущем потоке во время выставления и отмены ордеров новые обновления по вебсокету не приходят, но обновления ордер бука нам нужны, потому что по нему мы определяем цену оредров.
    \item Поэтому получения ордер бука вынесено в отдельный поток, чтобы всегда именть свежий стакан.
\end{enumerate}

\item Проверки положение ордеров
\begin{enumerate}
    \item Бывает так, что новые трейды не приходят, но окно спреда ордер бука меняется.
    \item Нам важно наше окно трейдов держать строго на $\pm$ какой-то спред вокруг бидсов и асков.
    \item Поэтому мы раз в какое-то время проверяем этот баланс, и если происходит дисбаланс, то мы обновляем наши ордера.
\end{enumerate}

\end{enumerate}

\subsection{Результаты}
Мы торговали на бирже \texttt{DyDx}. Она входит в топ самых популярных децентрализованных бирж. Количество сделок в месяц в ней около 30 тысяч и по биткоинку, и по эфиру. На самом деле это очень мало: в среднем $0.3$ сделки в секунду, то есть одна сделка в 3-4 секунды. Соответственно рынок совсем не высоко-инерционный, поэтому после того, как нас пробили в одну сторону, до пробития во вторую, может пройти несколько десятков минут. Это превышает наш таймаут, потому что если мы слишком долго будем держать открытую позицию, то повышается вероятность, что рынок пойдет в обратную сторону и мы потеряем еще больше денег.

Еще часто бывали случаи, когда рынок отскакивает в нужную нам сторону, но на величину меньше комиссии, соответственно, мы теряем деньги.

\subsection{Выводы}

Если бы у нас была нулевая или близка к нулевой комиссия, то мы бы были в плюсе. Но с той, что у нас есть, в минусе.