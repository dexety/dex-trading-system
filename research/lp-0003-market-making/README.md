# Attention
Не запускайте тестирующую систему или что-то еще, что отправляет оредра, если запущена эта стратегия.

Все из-за того, что для гаранирования корректности стратегии, здесь контролируется все состояние аккаунта. Поэтому если прилетят другие ордера или откроются позиции, то для стратегии это будет неопределенное поведение.

# Результаты

- Есть работающая стратежка

## Стратегия

- Держим окно с заданным спредом
- Если нас пробивают с одной стороны, то ждем, пока пробьют со второй в течении заданного времени
- Если за это время со второй стороны нас не пробили, то сливаем ордер как можно быстрее, но все равно как мэйкер

## Реализация

Есть три основных потока:

1. Для выставление ордеров
    1. В этом потоке мы получаем новый трейды
    2. Если цена нового трейда не такая, как у прошлого, и цена ордера, который надо выставить не такая, как у нас сейчас стоит, то мы отменяем текущие ордера и выставляем новые
    3. Перестановка ордеров переходит не через сначала отмену, старых, а потом выставления новых ордеров, а непосрественно через переставление позиций аргументом `cancel_id` в функции `create_order`. Это позволило сократить количество запросов в два раза, а значит ошибка `Too many requests` будет встречаться реже.
2. Для получение обновлений ордербука
    1. В предыдущем потоке во время выставления и отмены ордеров новые обновления по вебсокету не приходят, но обновления ордер бука нам нужны, потому что по нему мы определяем цену оредров.
    2. Поэтому получения ордер бука вынесено в отдельный поток, чтобы всегда именть свежий стакан
3. Чекер положение ордеров
    1. Бывает так, что новые трейды не приходят, но окно спреда ордер бука меняется
    2. Нам важно наше окно трейдов держать строго на +- какой-то спред вокруг бидсов и асков
    3. Поэтому мы раз в какое-то время проверяем этот баланс, и если происходит дисбаланс, то мы обновляем наши ордера

## Пробития

*Под пробитием будем понимать такой скачок, который потом отскакивает назад.*

Пробития существуют. Причем если скачок действительно пробитие, то есть после скачка, сразу идет обратный скачок, то в относительном соотношении он достаточно большой, больше 4 комиссий.

Проблема в том, как отличить пробитие от тренда и как с этим бороться. Есть два случая

- Пробитие
    - Тогда мы зарабатываем, потому что именно для пробитий построена эта стратегия
- Трендовый скачок
    - Если рынок в целом идет, скажем, вверх, то часто бывают приличные скачки, которые обратно не возващаются.
    - При таком скачке мы теряем деньги, потому что нам придется слить позицию, которая в минусе

Надо научиться отличать одно от другого. В качестве гипотезы, можно сказать, что в первом случае у нас будет трейдов меньше, но сами они будут большие, так как пробитие происходит из-за одного крупного игрока, а во втором случае, будет больше трейдов, но они будут меньше.

## AWS

На АВС задержка на отправку оредров меньше почти в три раза при слабой нагрузке на сервера dydx и в полтора раза при сильной нагрузке на dydx:

- Со своей машины в России
    - `0.3860666275024414` секунд во время слабой нагрузки на dydx
    - `0.501491904258728` секунд во время сильной нагрузки на dydx
- С АВС в штатах
    - `0.13387751579284668` секунд во время слабой нагрузки на dydx
    - `0.40620856285095214` секунд во время сильной нагрузки на dydx

Остальные функции исполняются за меньше, чем 50мс при слабой нагрузке

```bash
"get_user"
    "average": 0.02356255054473877
"get_our_accounts"
    "average": 0.02919425964355469
"get_symbol_info"
    "average": 0.0015918254852294923
"get_order_book"
    "average": 0.023754811286926268
"get_our_positions"
    "average": 0.06475324630737304
"get_our_orders"
    "average": 0.029773640632629394
"cancel_order"
    "average": 0.031336855888366696
```

И при сильной нагрузке

```bash
"get_user"
    "average": 0.03372049331665039
"get_our_accounts"
    "average": 0.029273343086242676
"get_symbol_info"
    "average": 0.001686692237854004
"get_order_book"
    "average": 0.028220129013061524
"get_our_positions"
    "average": 0.06414461135864258
"get_our_orders"
    "average": 0.029667091369628907
"send_limit_order"
    "average": 0.17861664295196533
"cancel_order"
    "average": 0.03619372844696045
```

Это данные из сервера в Северной Вирджинии. Для сервера в южной Калифорнии, задержка такая же, как в мск.

Я использовал веб-ноду Инфуры